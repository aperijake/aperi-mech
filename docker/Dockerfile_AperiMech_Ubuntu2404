# Dockerfile for building a CPU-only environment for the aperi-mech project on Ubuntu 24.04

# Base image, Ubuntu 24.04
FROM ubuntu:24.04

# Set the default shell to bash
SHELL ["/bin/bash", "-c"]

# Define the user and group id
ARG USER_ID=1000
ARG GROUP_ID=1000

# Verify user and group IDs are numbers
RUN if ! [[ "$USER_ID" =~ ^[0-9]+$ ]] || ! [[ "$GROUP_ID" =~ ^[0-9]+$ ]]; then \
        echo "Error: USER_ID and GROUP_ID must be numbers, not '${USER_ID}' and '${GROUP_ID}'" && \
        exit 1; \
    fi && \
    echo "USER_ID set to: ${USER_ID}" && \
    echo "GROUP_ID set to: ${GROUP_ID}"

# Avoid prompts from apt
ENV DEBIAN_FRONTEND=noninteractive

#################### System Packages from apt ####################
# Install necessary packages
# trunk-ignore(hadolint/DL3008)
# trunk-ignore(checkov/CKV2_DOCKER_1)
RUN apt-get update && apt-get install -y --no-install-recommends \
    autoconf \
    automake \
    build-essential \
    ca-certificates \
    cmake \
    coreutils \
    curl \
    environment-modules \
    file \
    gfortran \
    git \
    git-lfs \
    gpg \
    htop \
    lcov \
    libaec-dev \
    libbz2-dev \
    libcurl4-openssl-dev \
    libgl1 \
    libglu1-mesa \
    libhwloc-dev \
    liblz4-dev \
    libncurses-dev \
    libopenblas-dev \
    libsnappy-dev \
    libssl-dev \
    libtool \
    libxml2-dev \
    libzstd-dev \
    lsb-release \
    openssh-client \
    openssl \
    pkgconf \
    python3 \
    python3-full \
    python3-venv \
    python3-pip \
    sudo \
    unzip \
    vim \
    xorg \
    zip \
    && rm -rf /var/lib/apt/lists/*

#################### User Setup ####################
# Check if UID exists and handle accordingly, modify if exists, create if not. Can be set to match host for easy file sharing
RUN if getent passwd ${USER_ID} > /dev/null; then \
      echo "UID ${USER_ID} already exists, modifying existing user" && \
      existing_user=$(getent passwd ${USER_ID} | cut -d: -f1) && \
      usermod -l aperi-mech_docker $existing_user && \
      groupmod -n aperi-mech_docker $(id -gn $USER_ID) && \
      usermod -d /home/aperi-mech_docker -m aperi-mech_docker; \
    else \
      # Create the group first if it doesn't exist
      if ! getent group ${GROUP_ID}; then \
        groupadd -g ${GROUP_ID} aperi-mech_docker; \
      fi && \
      useradd -u ${USER_ID} -g ${GROUP_ID} -m aperi-mech_docker; \
    fi

# Switch back to root user
USER root

# Configure passwordless sudo for the user
RUN echo "aperi-mech_docker ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Change to the new user
USER aperi-mech_docker

# Make the working directory
WORKDIR /home/aperi-mech_docker

# Set the HOME environment variable
ENV HOME=/home/aperi-mech_docker

# Set the default command to bash
CMD ["/bin/bash"]

RUN git clone https://github.com/aperijake/aperi-mech.git ${HOME}/aperi-mech

# Change to the cloned repository directory
WORKDIR ${HOME}/aperi-mech

# Set the aperi_mech environment variable globally
ENV aperi_mech=${HOME}/aperi-mech

# Check out the specific branch for spack updates
RUN git fetch --all && \
    git checkout main

# Set Fortran compiler environment variables globally
ENV FC=/usr/bin/gfortran 
ENV F77=/usr/bin/gfortran

# Set up Python virtual environment and install required tooling
RUN python3 -m venv venv && \
    . ./venv/bin/activate && \
    echo "export aperi_mech=$aperi_mech" >> $aperi_mech/venv/bin/activate && \
    cd $aperi_mech/tools/python/aperi-mech && \
    python3 -m pip install -e . && \
    cd $aperi_mech/tools/python/spackx && \
    python3 -m pip install -e .

# Install Spack and add it to the virtual environment
RUN mkdir -p $aperi_mech/venv/src && \
    cd $aperi_mech/venv/src && \
    git clone https://github.com/spack/spack.git && \
    git -C $aperi_mech/venv/src/spack checkout prereleases/v1.0.0-alpha.4 && \
    echo "source $aperi_mech/venv/src/spack/share/spack/setup-env.sh" >> $aperi_mech/venv/bin/activate

# Configure the Spack environment
RUN . ./venv/bin/activate && \
    source $aperi_mech/venv/src/spack/share/spack/setup-env.sh && \
    spack compiler find && \
    spack external find && \
    spack external find cmake hwloc libxml2 pkgconf bzip2 lz4 snappy zstd libaec ncurses openblas autoconf automake libtool

# Patch Spack for Trilinos support
RUN . ./venv/bin/activate && \
    source $aperi_mech/venv/src/spack/share/spack/setup-env.sh && \
    spack patch-trilinos

# Create a Spack environment for aperi-mech and install it
RUN . ./venv/bin/activate && \
    source $aperi_mech/venv/src/spack/share/spack/setup-env.sh && \
    spack env create aperi-mech && \
    spack -e aperi-mech develop --path $aperi_mech aperi-mech && \
    spack -e aperi-mech add aperi-mech build_type=Release && \
    spack -e aperi-mech concretize -f && \
    spack -e aperi-mech install

# Set environment variables for aperi-mech
ENV APERI_MECH_ENV="aperi-mech"
ENV APERI_MECH_CPU_ENV="aperi-mech"

# Register the local aperi-mech Spack repository so the aperi-mech repo can be found for future builds
RUN . ./venv/bin/activate && \
    source $aperi_mech/venv/src/spack/share/spack/setup-env.sh && \
    spack -e aperi-mech repo add $aperi_mech/tools/python/spackx/src/spackx/repos/aperi/

# When running the container, first do: source $aperi_mech/venv/bin/activate

# To get the build location of aperi-mech, you can run:
#   spacktivate aperi-mech
#   spack location -i aperi-mech build_type=Release
# Then cd to the bin folder in that directory to run the unit tests
# Same for the Debug build

# To build aperi-mech with build_type=Debug in the same environment, in the container you can run:
#   spacktivate aperi-mech && \
#   spack config edit
#    change concretizer:unify to false # enables multiple builds in the same environment
#   spack add aperi-mech build_type=Debug 
#   spack install build_type=Debug
# May get some error about the environment view, but it seems to not be an issue

# Or, you can use the do_configure script to build manually

# Generic healthcheck to ensure the container is running
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
  CMD [ "bash", "-c", "echo 'Container is healthy'" ]